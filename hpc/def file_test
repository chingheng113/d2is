Bootstrap: yum
OSVersion: 7
MirrorURL: http://mirror.centos.org/centos-%{OSVERSION}/%{OSVERSION}/os/$basearch/
Include: yum

%labels
    Author Ching-Heng Lin
    Version v0.0.1
%post
    # Core system capabilities required
    yum update -y && yum install -y \
        bc \
        build-essential \
        dc \
        git \
        libopenblas-dev \
        nano \
        nodejs-legacy \
        npm \
        perl-modules \
        tar \
        tcsh \
        unzip \
        wget \
        tzdata \
        libeigen3-dev \
        libfftw3-dev \
        libtiff5-dev \
        zlib1g-dev \
        python3
    python3 -m ensurepip
    yum groupinstall -y "Development Tools"

    # For Freesurfer
    yum -y install binutils libgomp1 perl psmisc sudo tcsh uuid-dev vim-common libjpeg62-dev parallel

    # For FSL
    yum -y install epel-release
    yum -y install openblas-devel

    # For matlab runtime
    yum install -y java-1.8.0-openjdk

    # For X
    yum install -y xorg-x11-server-Xvfb xorg-x11-xauth which

    # For PDF outputs
    yum install -y ImageMagick

    # Install FSL
    wget -nv -P /opt https://fsl.fmrib.ox.ac.uk/fsldownloads/fsl-6.0.4-centos7_64.tar.gz
    cd /opt
    tar -zxf fsl-6.0.4-centos7_64.tar.gz -C /opt
    export FSLDIR=/opt/fsl
    $FSLDIR/etc/fslconf/post_install.sh -f $FSLDIR
    rm fsl-6.0.4-centos7_64.tar.gz

    # Matlab runtime for brainstem, hippocampus, thalamus modules
    wget -nv -P /opt http://ssd.mathworks.com/supportfiles/downloads/R2014b/deployment_files/R2014b/installers/glnxa64/MCR_R2014b_glnxa64_installer.zip
    cd /opt
    unzip -q /opt/MCR_R2014b_glnxa64_installer.zip -d /opt/MCR_R2014b_glnxa64_installer
    /opt/MCR_R2014b_glnxa64_installer/install -mode silent -agreeToLicense yes
    rm -r /opt/MCR_R2014b_glnxa64_installer
    rm /opt/MCR_R2014b_glnxa64_installer.zip

    # Install Freesurfer 7.1.1
    wget -nv -P /opt https://surfer.nmr.mgh.harvard.edu/pub/dist/freesurfer/7.1.1/freesurfer-linux-centos7_x86_64-7.1.1.tar.gz
    cd /opt
    tar -zxf freesurfer-linux-centos7_x86_64-7.1.1.tar.gz -C /opt
    rm freesurfer-linux-centos7_x86_64-7.1.1.tar.gz

    # Freeview needs a machine id here
    dbus-uuidgen > /etc/machine-id

    # Tell freesurfer where to find the MCR
    ln -s /opt/MATLAB/MATLAB_Compiler_Runtime/v84 /opt/freesurfer/MCRv84

    # Create input/output directories for binding
    mkdir /INPUTS && mkdir /OUTPUTS


%environment

    # Freesurfer
    export FREESURFER_HOME=/opt/freesurfer

    # Make FSL happy
    export PATH=$FSLDIR/bin:$PATH
    /bin/bash -c 'source /opt/fsl/etc/fslconf/fsl.sh'
    export FSLMULTIFILEQUIT=TRUE
    export FSLOUTPUTTYPE=NIFTI

    # Make FreeSurfer happy
    export PATH=/opt/freesurfer/bin:/opt/freesurfer/mni/bin:$PATH
    export OS=Linux
    export SUBJECTS_DIR=/opt/freesurfer/subjects
    export FSF_OUTPUT_FORMAT=nii.gz
    export MNI_DIR=/opt/freesurfer/mni
    export LOCAL_DIR=/opt/freesurfer/local
    export FREESURFER_HOME=/opt/freesurfer
    export FSFAST_HOME=/opt/freesurfer/fsfast
    export MINC_BIN_DIR=/opt/freesurfer/mni/bin
    export MINC_LIB_DIR=/opt/freesurfer/mni/lib
    export MNI_DATAPATH=/opt/freesurfer/mni/data
    export FMRI_ANALYSIS_DIR=/opt/freesurfer/fsfast
    export PERL5LIB=/opt/freesurfer/mni/lib/perl5/5.8.5
    export MNI_PERL5LIB=/opt/freesurfer/mni/lib/perl5/5.8.5

%runscript
    exec /bin/bash "$@"

%help
    I need somebody
    (Help!) not just anybody
    (Help!) you know I need someone
    Help!